{% extends "layouts/public_base.html" %}
{% block content %}
<section class="kv-stack">
  <div><h1 class="kv-title">Upload</h1><p class="kv-subtitle">Lade Prüfungen oder Lernstoff hoch. Dein Beitrag wird vor der Veröffentlichung geprüft.</p></div>
  <div class="kv-card kv-stack" style="gap:18px;">
    <div class="kv-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
      <div class="kv-field"><label for="id_content_type">Typ</label>{{ form.content_type }}</div>
      <div class="kv-field"><label for="id_category">Kategorie</label><select id="id_category" name="category" class="kv-input"><option value="">Bitte wählen</option>{% for category in categories %}<option value="{{ category.id }}">{{ category.name }}</option>{% endfor %}</select></div>
      <div class="kv-field"><label for="id_subcategory">Subkategorie</label><select id="id_subcategory" name="subcategory" class="kv-input" disabled><option value="">Optional</option>{% for subcategory in subcategories %}<option value="{{ subcategory.id }}" data-category="{{ subcategory.category_id }}">{{ subcategory.name }}</option>{% endfor %}</select></div>
    </div>
    <div id="upload-dropzone" class="kv-card kv-dropzone">
      <p style="margin:0;font-weight:600;">Dateien hierher ziehen</p><p class="kv-note" style="margin-top:6px;">oder Dateien auswählen</p>
      <label class="kv-btn kv-btn-primary" style="margin-top:10px;">Dateien auswählen<input id="file-input" type="file" multiple hidden accept=".pdf,.docx,.pptx,.xlsx,.jpg,.jpeg,.png,.zip" /></label>
      <p class="kv-note" style="margin-top:10px;">Max. {{ max_files }} Dateien, {{ max_file_size_mb }} MB pro Datei. Erlaubt: {{ allowed_extensions }}.</p>
    </div>
    <div id="batch-status" class="kv-card" style="display:none;border-color:#C6A15B;background:#fffaf0;"><strong>Batch erstellt.</strong> Du kannst deine Dateien als ZIP herunterladen.</div>
    <div class="kv-stack" style="gap:12px;"><h3 style="margin:0;">Dateien</h3><div id="file-list" class="kv-stack" style="gap:12px;"></div><div id="upload-errors" class="kv-note" style="color:#b91c1c;"></div></div>
    <div class="kv-page-header" style="justify-content:flex-start;gap:12px;"><button id="cancel-button" type="button" class="kv-btn kv-btn-secondary">Abbrechen</button><button id="upload-button" type="button" class="kv-btn kv-btn-primary" disabled>Hochladen</button><button id="download-button" type="button" class="kv-btn kv-btn-primary" disabled>ZIP herunterladen</button></div>
  </div>
</section>
<script>
const qs=(s)=>document.querySelector(s),drop=qs('#upload-dropzone'),input=qs('#file-input'),list=qs('#file-list'),btnUpload=qs('#upload-button'),btnCancel=qs('#cancel-button'),btnDownload=qs('#download-button'),errors=qs('#upload-errors'),statusBox=qs('#batch-status'),cat=qs('#id_category'),sub=qs('#id_subcategory');
const maxFiles={{ max_files }},maxSize={{ max_file_size_mb }}*1024*1024,exts=new Set(['.pdf','.docx','.pptx','.xlsx','.jpg','.jpeg','.png','.zip']);let batchId=null,token=null,pending=[];
const cookie=(n)=>{const v=`; ${document.cookie}`.split(`; ${n}=`);return v.length===2?v.pop().split(';').shift():'';};
const updateSub=()=>{const v=cat.value;[...sub.options].forEach(o=>{o.hidden=!!o.value&&o.dataset.category!==v;});sub.value='';sub.disabled=!v;};
const addRow=(file)=>{const row=document.createElement('div');row.className='kv-card';row.dataset.name=file.name;row.innerHTML=`<div style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;"><div><strong>${file.name}</strong><div class="kv-note">${(file.size/1048576).toFixed(2)} MB</div><div class="kv-note" data-status>Bereit</div><div style="margin-top:6px;background:#f1f5f9;border-radius:6px;overflow:hidden;"><div data-progress style="height:8px;width:0%;background:#0F3D32;"></div></div></div><button data-action="remove" class="kv-btn kv-btn-secondary" type="button">Entfernen</button></div>`;list.appendChild(row);return row;};
const validate=(files)=>{const errs=[],total=list.children.length+files.length;if(total>maxFiles)errs.push(`Maximal ${maxFiles} Dateien pro Upload.`);files.forEach(f=>{const e='.'+f.name.split('.').pop().toLowerCase();if(!exts.has(e))errs.push(`${f.name}: Dateityp nicht erlaubt.`);if(f.size>maxSize)errs.push(`${f.name}: Datei ist zu gross.`);});return errs;};
const createBatch=async()=>{if(batchId)return batchId;const payload={content_type:qs('#id_content_type').value,category:cat.value||'',subcategory:sub.value||''};const res=await fetch('/api/upload-batches/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':cookie('csrftoken')},body:JSON.stringify(payload)});const data=await res.json();if(!res.ok)throw new Error('Batch konnte nicht erstellt werden.');batchId=data.batch_id;token=data.upload_token;statusBox.style.display='block';btnDownload.disabled=false;return batchId;};
const uploadFile=async(file,row)=>{const bar=row.querySelector('[data-progress]'),status=row.querySelector('[data-status]'),remove=row.querySelector('[data-action="remove"]');status.textContent='Upload läuft...';const batch=await createBatch();const form=new FormData();form.append('files',file);const xhr=new XMLHttpRequest();xhr.open('POST',`/api/upload-batches/${batch}/files/`);xhr.setRequestHeader('X-CSRFToken',cookie('csrftoken'));xhr.setRequestHeader('X-Upload-Token',token);xhr.upload.onprogress=(e)=>{if(e.lengthComputable){bar.style.width=`${((e.loaded/e.total)*100).toFixed(0)}%`;}};xhr.onload=()=>{if(xhr.status===201){const resp=JSON.parse(xhr.responseText);row.dataset.fileId=resp.files[0].id;status.textContent='Erfolgreich hochgeladen';}else{status.textContent='Upload fehlgeschlagen';}updateButtons();};xhr.onerror=()=>{status.textContent='Upload fehlgeschlagen';updateButtons();};remove.addEventListener('click',async()=>{if(row.dataset.fileId){await fetch(`/api/upload-files/${row.dataset.fileId}/`,{method:'DELETE',headers:{'X-CSRFToken':cookie('csrftoken'),'X-Upload-Token':token}});}else{pending=pending.filter((f)=>f.name!==file.name);}row.remove();updateButtons();});xhr.send(form);};
const handle=(files)=>{const incoming=[...files],errs=validate(incoming);if(errs.length){errors.textContent=errs.join(' ');return;}errors.textContent='';incoming.forEach(f=>{pending.push(f);const row=addRow(f);row.querySelector('[data-action="remove"]').addEventListener('click',()=>{pending=pending.filter((p)=>p.name!==f.name);});});updateButtons();};
const updateButtons=()=>{btnUpload.disabled=!pending.length;btnDownload.disabled=!batchId;};
btnUpload.addEventListener('click',async()=>{const queue=[...pending];pending=[];updateButtons();for(const file of queue){const row=list.querySelector(`[data-name="${CSS.escape(file.name)}"]`);if(row){await uploadFile(file,row);}}});
btnCancel.addEventListener('click',()=>{pending=[];list.innerHTML='';errors.textContent='';updateButtons();});
btnDownload.addEventListener('click',()=>{if(batchId){window.open(`/api/upload-batches/${batchId}/download.zip?upload_token=${token}`,'_blank');}});
drop.addEventListener('dragover',(e)=>{e.preventDefault();drop.classList.add('is-active');});drop.addEventListener('dragleave',()=>{drop.classList.remove('is-active');});drop.addEventListener('drop',(e)=>{e.preventDefault();drop.classList.remove('is-active');handle(e.dataTransfer.files);});
input.addEventListener('change',(e)=>{handle(e.target.files);input.value='';});cat.addEventListener('change',updateSub);updateSub();
</script>
{% endblock content %}

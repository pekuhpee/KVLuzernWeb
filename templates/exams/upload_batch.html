{% extends "layouts/public_base.html" %}
{% block content %}
<section class="kv-stack">
  <div><h1 class="kv-title">Upload</h1><p class="kv-subtitle">Lade Prüfungen oder Lernstoff hoch. Dein Beitrag wird vor der Veröffentlichung geprüft.</p></div>
  <form id="upload-form" method="post" enctype="multipart/form-data" class="kv-card kv-stack" style="gap:18px;">
    {% csrf_token %}
    <div class="kv-grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
      <div class="kv-field"><label for="id_type_option">{{ meta_labels.type|default:"Typ" }}</label>{{ form.type_option }}</div>
      <div class="kv-field"><label for="id_year_option">{{ meta_labels.year|default:"Jahr" }}</label>{{ form.year_option }}</div>
      <div class="kv-field"><label for="id_subject_option">{{ meta_labels.subject|default:"Fach" }}</label>{{ form.subject_option }}</div>
      <div class="kv-field"><label for="id_teacher">{{ meta_labels.teacher|default:"Lehrer" }}</label>{{ form.teacher }}</div>
      <div class="kv-field"><label for="id_program_option">{{ meta_labels.program|default:"Programm" }}</label>{{ form.program_option }}</div>
    </div>
    <div id="upload-dropzone" class="kv-card kv-dropzone">
      <p style="margin:0;font-weight:600;">Dateien hierher ziehen</p><p class="kv-note" style="margin-top:6px;">oder Dateien auswählen</p>
      <label class="kv-btn kv-btn-primary" style="margin-top:10px;">Dateien auswählen<input id="file-input" name="files" type="file" multiple hidden accept=".pdf,.docx,.pptx,.xlsx,.jpg,.jpeg,.png,.zip" /></label>
      <p class="kv-note" style="margin-top:10px;">Max. {{ max_files }} Dateien, {{ max_file_size_mb }} MB pro Datei. Erlaubt: {{ allowed_extensions }}.</p>
    </div>
    <div id="batch-status" class="kv-card" style="display:none;border-color:#C6A15B;background:#fffaf0;"><strong>Batch erstellt.</strong> Du kannst deine Dateien hochladen.</div>
    <div class="kv-stack" style="gap:12px;"><h3 style="margin:0;">Dateien</h3><div id="file-list" class="kv-stack" style="gap:12px;"></div><div id="upload-errors" class="kv-note" style="color:#b91c1c;">{% if server_errors %}{{ server_errors|join:" " }}{% endif %}</div></div>
    <div class="kv-page-header" style="justify-content:flex-start;gap:12px;"><button id="cancel-button" type="button" class="kv-btn kv-btn-secondary">Abbrechen</button><button id="upload-button" type="submit" class="kv-btn kv-btn-primary">Hochladen</button></div>
  </form>
</section>
<script>
const qs=(s)=>document.querySelector(s),form=qs('#upload-form'),drop=qs('#upload-dropzone'),input=qs('#file-input'),list=qs('#file-list'),btnUpload=qs('#upload-button'),btnCancel=qs('#cancel-button'),errors=qs('#upload-errors'),statusBox=qs('#batch-status');
const typeOption=qs('#id_type_option'),yearOption=qs('#id_year_option'),subjectOption=qs('#id_subject_option'),teacherOption=qs('#id_teacher'),programOption=qs('#id_program_option');
const maxFiles={{ max_files }},maxSize={{ max_file_size_mb }}*1024*1024,exts=new Set(['.pdf','.docx','.pptx','.xlsx','.jpg','.jpeg','.png','.zip']);let batchId=null,token=null,pending=[],isUploading=false;
const cookie=(n)=>{const v=`; ${document.cookie}`.split(`; ${n}=`);return v.length===2?v.pop().split(';').shift():'';};
const csrfToken=()=>cookie('csrftoken')||qs('[name=csrfmiddlewaretoken]')?.value||'';
const removePending=(file)=>{pending=pending.filter((p)=>p.name!==file.name);};
const removeRow=async(row,file)=>{if(row.dataset.fileId){await fetch(`/api/upload-files/${row.dataset.fileId}/`,{method:'DELETE',headers:{'X-CSRFToken':csrfToken(),'X-Upload-Token':token||''}});}else{removePending(file);}row.remove();updateButtons();};
const addRow=(file)=>{const row=document.createElement('div');row.className='kv-card';row.dataset.name=file.name;row.innerHTML=`<div style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;"><div><strong>${file.name}</strong><div class="kv-note">${(file.size/1048576).toFixed(2)} MB</div><div class="kv-note" data-status>Bereit</div><div style="margin-top:6px;background:#f1f5f9;border-radius:6px;overflow:hidden;"><div data-progress style="height:8px;width:0%;background:#0F3D32;"></div></div></div><button data-action="remove" class="kv-btn kv-btn-secondary" type="button">Entfernen</button></div>`;row.querySelector('[data-action="remove"]').addEventListener('click',()=>{removeRow(row,file);});list.appendChild(row);return row;};
const validate=(files)=>{const errs=[],total=list.children.length+files.length;if(total>maxFiles)errs.push(`Maximal ${maxFiles} Dateien pro Upload.`);files.forEach(f=>{const e='.'+f.name.split('.').pop().toLowerCase();if(!exts.has(e))errs.push(`${f.name}: Dateityp nicht erlaubt.`);if(f.size>maxSize)errs.push(`${f.name}: Datei ist zu gross.`);});return errs;};
const safeJson=async(res)=>{try{return await res.json();}catch{return {};}};
const createBatch=async()=>{if(batchId)return batchId;const tokenValue=csrfToken();if(!tokenValue)throw new Error('CSRF Token fehlt. Bitte Seite neu laden.');const payload={type_option:typeOption.value,year_option:yearOption.value,subject_option:subjectOption.value,teacher:teacherOption.value,program_option:programOption.value};const res=await fetch('/api/upload-batches/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':tokenValue},body:JSON.stringify(payload)});const data=await safeJson(res);if(!res.ok){const details=data?.detail||data?.errors&&Object.values(data.errors).flat().join(' ')||'Batch konnte nicht erstellt werden.';throw new Error(details);}batchId=data.batch_id;token=data.upload_token;statusBox.style.display='block';return batchId;};
const uploadFile=async(file,row)=>{const bar=row.querySelector('[data-progress]'),status=row.querySelector('[data-status]');status.textContent='Upload wird vorbereitet...';let batch=null;try{batch=await createBatch();}catch(err){status.textContent='Upload fehlgeschlagen';errors.textContent=err?.message||'Upload fehlgeschlagen.';console.error(err);return false;}status.textContent='Upload läuft...';const tokenValue=csrfToken();const form=new FormData();form.append('files',file);return await new Promise((resolve)=>{const xhr=new XMLHttpRequest();xhr.open('POST',`/api/upload-batches/${batch}/files/`);xhr.setRequestHeader('X-CSRFToken',tokenValue);if(token){xhr.setRequestHeader('X-Upload-Token',token);}xhr.upload.onprogress=(e)=>{if(e.lengthComputable){bar.style.width=`${((e.loaded/e.total)*100).toFixed(0)}%`;}};xhr.onload=()=>{let resp={};try{resp=xhr.responseText?JSON.parse(xhr.responseText):{};}catch(parseErr){console.error(parseErr);};if(xhr.status===201){row.dataset.fileId=resp.files?.[0]?.id||'';status.textContent='Erfolgreich hochgeladen';resolve(true);}else{status.textContent='Upload fehlgeschlagen';errors.textContent=resp?.error||resp?.errors?.join?.(' ')||`Upload fehlgeschlagen (Status ${xhr.status}).`;console.error(resp);resolve(false);}updateButtons();};xhr.onerror=()=>{status.textContent='Upload fehlgeschlagen';errors.textContent='Upload fehlgeschlagen. Bitte erneut versuchen.';console.error('Upload fehlgeschlagen');updateButtons();resolve(false);};xhr.send(form);});};
const handle=(files)=>{const incoming=[...files],errs=validate(incoming);if(errs.length){errors.textContent=errs.join(' ');return;}errors.textContent='';incoming.forEach(f=>{pending.push(f);addRow(f);});updateButtons();};
const updateButtons=()=>{btnUpload.disabled=!pending.length||isUploading;};
form.addEventListener('submit',async(e)=>{e.preventDefault();if(isUploading||!pending.length)return;errors.textContent='';isUploading=true;updateButtons();const queue=[...pending];for(const file of queue){const row=list.querySelector(`[data-name="${CSS.escape(file.name)}"]`);if(!row)continue;const success=await uploadFile(file,row);if(success){removePending(file);}}isUploading=false;updateButtons();if(!pending.length&&batchId){const tokenParam=token?`?upload_token=${encodeURIComponent(token)}`:'';window.location.href=`/upload/success/${batchId}/${tokenParam}`;}});
btnCancel.addEventListener('click',()=>{pending=[];list.innerHTML='';errors.textContent='';updateButtons();});
drop.addEventListener('dragover',(e)=>{e.preventDefault();drop.classList.add('is-active');});drop.addEventListener('dragleave',()=>{drop.classList.remove('is-active');});drop.addEventListener('drop',(e)=>{e.preventDefault();drop.classList.remove('is-active');handle(e.dataTransfer.files);});
input.addEventListener('change',(e)=>{handle(e.target.files);input.value='';});
updateButtons();
</script>
{% endblock content %}
